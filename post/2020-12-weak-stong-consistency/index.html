<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Dr. Jim Webber">

  
  
  
    
  
  <meta name="description" content="Thoughts on the design of distributed graph databases that use strongly consistent methods for the data stored on their shards, but pay no regard to ordering of concurrent updates.">

  
  <link rel="alternate" hreflang="en-us" href="/post/2020-12-weak-stong-consistency/">

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    
      

      
      

      
    

  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
    
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu8d95d3ff713524d6d0121b98b85c750c_16505_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu8d95d3ff713524d6d0121b98b85c750c_16505_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="/post/2020-12-weak-stong-consistency/">

  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="World Wide Webber">
  <meta property="og:url" content="/post/2020-12-weak-stong-consistency/">
  <meta property="og:title" content="Strong Consitency Claims in Distributed Graph Databases | World Wide Webber">
  <meta property="og:description" content="Thoughts on the design of distributed graph databases that use strongly consistent methods for the data stored on their shards, but pay no regard to ordering of concurrent updates."><meta property="og:image" content="/images/icon_hu8d95d3ff713524d6d0121b98b85c750c_16505_512x512_fill_lanczos_center_2.png">
  <meta property="twitter:image" content="/images/icon_hu8d95d3ff713524d6d0121b98b85c750c_16505_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-12-03T00:00:47&#43;00:00">
    
    <meta property="article:modified_time" content="2020-12-03T00:00:47&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/2020-12-weak-stong-consistency/"
  },
  "headline": "Strong Consitency Claims in Distributed Graph Databases",
  
  "datePublished": "2020-12-03T00:00:47Z",
  "dateModified": "2020-12-03T00:00:47Z",
  
  "author": {
    "@type": "Person",
    "name": "Dr. Jim Webber"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "World Wide Webber",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/icon_hu8d95d3ff713524d6d0121b98b85c750c_16505_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "Thoughts on the design of distributed graph databases that use strongly consistent methods for the data stored on their shards, but pay no regard to ordering of concurrent updates."
}
</script>

  

  


  


  





  <title>Strong Consitency Claims in Distributed Graph Databases | World Wide Webber</title>

</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class=" ">

  
  
  
    <script>window.staDarkLightChooser = true;</script>
  
  
    <script>const isSiteThemeDark = false;</script>
  
  
  <script src="/js/load-theme.js"></script>

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">World Wide Webber</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">World Wide Webber</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#talks"><span>Talks</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#books"><span>Books</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Blog</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Professional Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#social-media"><span>Social Media</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link js-theme-selector" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-palette" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>



  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Strong Consitency Claims in Distributed Graph Databases</h1>

  
  <p class="page-subtitle">When is strongly consistent not strongly consistent? When it&rsquo;s not consistently used.</p>
  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Dec 3, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    14 min read
  </span>
  

  
  
  

  
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <h2 id="motivation">Motivation</h2>
<p>For several years, I&rsquo;ve been working with 
<a href="https://www.ncl.ac.uk/computing/people/profile/paulezhilchelvan.html" target="_blank" rel="noopener">Paul Ezhilchelvan</a>, 
<a href="https://www.ncl.ac.uk/computing/people/profile/isimitrani.html#background" target="_blank" rel="noopener">Isi Mitrani</a>, and 
<a href="https://www.ncl.ac.uk/bigdata/people/people/waudbyjack.html" target="_blank" rel="noopener">Jack Waudby</a> from 
<a href="https://www.ncl.ac.uk/computing/" target="_blank" rel="noopener">Newcastle University</a>. We&rsquo;ve working on consistency models specifically for <em>graph</em> databases, trying to understand whether consistency models for graph databases are different from other database types and if so how we can preserve correctness while still being useful for demanding production systems. This post is a summary of the work we&rsquo;ve done for a technical generalist audience, and I hope you enjoy reading it.</p>
<p>The work has been both fun and fruitful. Our focus has been on <em>edge-distributed graph databases</em>. In this kind of system, nodes (or vertices) reside on a single shard in the system, and relationships (or edges) can connect nodes within that shard <em>and</em> across shards over the network. This results in a model where no denormalisation of the data model is necessary.</p>


















<figure id="figure-nodes-representing-karl-and-rosa-are-on-different-servers-and-there-is-a-follows-relationshipedge-between-them-which-crosses-the-network">


  <a data-fancybox="" href="edge-distributed-graph-database.png" data-caption="Nodes representing &lt;code&gt;Karl&lt;/code&gt; and &lt;code&gt;Rosa&lt;/code&gt; are on different servers, and there is a &lt;code&gt;FOLLOWS&lt;/code&gt; relationship/edge between them which crosses the network.">


  <img src="edge-distributed-graph-database.png" alt="" width="80%" >
</a>


  
  
  <figcaption>
    Nodes representing <code>Karl</code> and <code>Rosa</code> are on different servers, and there is a <code>FOLLOWS</code> relationship/edge between them which crosses the network.
  </figcaption>


</figure>

<p>During our collaboration, we&rsquo;ve identified an important safety property called 
<a href="https://dl.acm.org/doi/10.1145/3380787.3393675" target="_blank" rel="noopener">Reciprocal Consistency</a>. Put simply, if the record that stores the <code>Karl</code> node on <code>Server 1</code> has an entry for an <em>outgoing</em> <code>FOLLOWS</code> relationship to the <code>Rosa</code> node on <code>Server 2</code> then the record representing the <code>Rosa</code> node should have an entry for an <em>incoming</em> relationship from the <code>Karl</code> node. This stems from the labelled proprety graph model where relationships can be traversed in either direction. Generally, the nodes at the head and tail of a relationship hold reciprocal information, hence are <em>reciprocaly consistent</em>.</p>
<hr>
<p>If you&rsquo;re not familar with graphs, an analogy is to think of foreign key relationships in relational databases.
Foreign keys constraints are used to prevent actions that would destroy links between tables and render the model incorrect.
Foreign key constraints enforce integrity between a parent table and a child table.
The parent table must reference some value in a column in the child table otherwise the constraint is violated (and the transaction causing the update will be rejected).
The difference with reciprocal consistency for graphs is that both tables would be parent and child <em>to each other</em> to ensure the integrity of the relationship between them.</p>
<hr>
<p>Maintaining reciprocal consistency isn&rsquo;t well addressed in the literature. Some distributed relational databases, like 
<a href="https://blog.yugabyte.com/relational-data-modeling-with-foreign-keys-in-a-distributed-sql-database/" target="_blank" rel="noopener">YugabyteDB</a>, preserve foreign key constraints by using strongly consistent (serializable) transaction protocols only where strictly necessary for correctiness and using less expensive (snapshot) protocols everywhere else.</p>
<p>In the case of graph databases, the equivalent of foreign key constraints aren&rsquo;t a special case. Relationships in a graph are plentiful and the chance of any individual relationship being distributed across servers (or shards) is around 30% with a good partitioning algorithm like 
<a href="https://theses.ncl.ac.uk/jspui/bitstream/10443/4416/1/Firth%20H%202018.pdf" target="_blank" rel="noopener">Hugo Firth&rsquo;s Taper</a>.</p>
<p>To preserve correctness in an edge-distributed graph database we could choose to fallback to a conservative transaction protocol (like two-phase commit), but we know that will harm performance as a blocking protocol. If we use cheaper models like eventual consistency, we might lose reciprocal consistency. In fact we found that 
<a href="http://qmsm.pu.edu.tw/papers/paper/QMSM-2020-6-04_corrected_proof.pdf" target="_blank" rel="noopener">eventually-consistent edge-distributed graph databases will corrupt data under normal operation</a> to the extent that a large, busy production database may be rendered useless a matter of months.</p>
<p>But this article isn&rsquo;t really about eventual consistency. Although we started with eventual consistency in mind, our enquiries lead to a more fundamental question: <em>if eventual consistency leads to corruption, are so-called strongly consistent systems immune from corruption for edge-distributed graph databases?</em> Given that question, we&rsquo;ve lately focussed on systems designs that claim to be strongly consistent (using words like ACID) but which nonetheless fail to uphold reciprocal consistency, causing corruption in normal (no-fault) operation.</p>
<p>Corruption by design is a shocking (and fascinating) result in a strongly consistent system. I&rsquo;ll dig <em>much</em> deeper into the root cause in a moment. But first a little history as to how we found ourselves here.</p>
<h2 id="the-trouble-with-eventually-consistent-graph-databases">The trouble with eventually-consistent graph databases</h2>
<p>A few years ago when the (now abandoned) 
<a href="http://espeed.github.io/titandb/" target="_blank" rel="noopener">TitanDB</a> was launched I recall thinking that its design was problematic from a safety and performance viewpoint. For performance, the problems were around locality. TitanDB spreads bits of the graph across servers to boost write performance, with less regard to how the data would be queried - the expectation is that most queries will have to cross servers to complete, adding complexity and latency. But a slow database is might still be a safe database, but TitanDB wasn&rsquo;t safe - in allowing uncoordinated writes across servers, race conditions could occur which would leave the database in inconsistent state.</p>
<p>This is partially understandable. The primary motivation for TitanDB, its successor 
<a href="https://janusgraph.org/" target="_blank" rel="noopener">JanusGraph</a>, and other similar graph databses was scalability. I think it was a rational decision: the market places a premium on scalability and scalability non-trivial if you also want safety and performance. What I think also helped is that the market tended to assume that features like performance and safety were innately part of anything called a <em>database</em>.</p>
<p>Of course, scale does not necessarily mean high-performance in absolute terms. Scale means you can add more computers to a system and perform more processing relative to fewer computers in the same system. It&rsquo;s often why 
<a href="https://youtu.be/Z7N6YWH1MKU?list=PL9Hl4pk2FsvUQY5FWQb0y6DqP5rmyyYji&amp;t=1922" target="_blank" rel="noopener">Neo4j on a laptop can humiliate scale-out graph databases on many powerful servers</a>.</p>
<p>In our work we were less concerned about performance, and much more about the safety properties of eventually-consistent graph databases. You probably already know that eventual consistency provides a straightforward guarantee for a single replica set that it will converge to the same value eventually (perhaps even before the next read in good systems). The value converged upon is influenced by the chosen concurrency control mechanisms (e.g. Last Writer Wins versus Logical Clocks etc), but nonetheless the guarantee is strictly for <em>one replica set/shard</em>. This might be fine for some data types, but we strongly suspected that it is not fine for edge-distributed graphs. Spoiler: it isn&rsquo;t.</p>
<h2 id="sources-of-corruption-in-eventually-consistent-graph-databases">Sources of corruption in eventually-consistent graph databases</h2>
<p>Eventually consistent databases scale because they avoid costly/centralised operations. Because of that, there&rsquo;s no coordination/ordering  across the database, just local concurrency controls on each server. The concurrency control might be simple and cheap like Last-Writer-Wins (LWW) or it might be a fancy merge function, but whatever mechanism is chosen, it acts locally on each server. Fortunately anti-entropy functions are available on most databases so that divergence between replicas within a set can be salvaged (though such functions tend not to be aggresively used in case they inhibit performance).</p>
<p>Even with anti-entropy functionality, with an eventually consistent distributed graph database there are two primary sources of potential corruption:</p>
<ol>
<li>The current transaction happens to read from a replica which is stale and uses that stale data to for updates. This is more complex than the same situation in a KV, document, or column store because graph database queries touch arbitrary keys and so undoing logical corruption is impractical and typically impossible. However, this is solvable with approaches like quorum reads though they will slow down the operation of the database considerably.</li>
<li>Two transactions contend on a single relationship/egde which happens to span replica sets (shards from here on) and are applied in a mutually inconsistent order. This is also solvable but requires some functionality to impose ordering, which is expensive completely undermines eventual consistency, and so nobody does this because it implies transactions.</li>
</ol>
<p>The TitanDB team were 
<a href="http://s3.thinkaurelius.com/docs/titan/1.0.0/eventual-consistency.html#_data_inconsistency" target="_blank" rel="noopener">rigorous enough to call out this problem</a>, but the language they used downplays its signficance. The documentation uses phrases like &ldquo;temporary inconsistency&rdquo; rather than &ldquo;corruption that might be repaired, but might also cause further irreperable corruption&rdquo; and &ldquo;half edges&rdquo; rather than &ldquo;corrupted edge records&rdquo;. While I don&rsquo;t think this mollifying language has directly lead to a slew of copycat databases, it certainly set a tone for ignoring safety properties (which is still followed by other databases in the family).</p>
<h2 id="quantifying-corruption-in-no-fault-systems">Quantifying corruption in no-fault systems</h2>
<p>It&rsquo;s unsettling to be looking for data corruption for databases operating in a fault-free environment. The word &ldquo;database&rdquo; is closely associated with the notion of safety - we expect to be able to retrieve what we&rsquo;ve stored.</p>
<p>Our starting point was the prior tacit admission of a possible 
<a href="http://s3.thinkaurelius.com/docs/titan/1.0.0/eventual-consistency.html#_data_inconsistency" target="_blank" rel="noopener">technical error case</a> from the TitanDB developers. We didn&rsquo;t know, however, if it would be a problem im real systems running in production for a long time. We could just have run the database with a representative workload for many months, but waiting around in real time to see if corruption would occur is expensive in both time and infrastructure bills.</p>
<p>Instead, I asked academics 
<a href="https://www.ncl.ac.uk/computing/people/profile/paulezhilchelvan.html#background" target="_blank" rel="noopener">Paul Ezhilchelvan</a> and 
<a href="https://www.ncl.ac.uk/computing/people/profile/isimitrani.html#background" target="_blank" rel="noopener">Isi Mitrani</a> for help. In a way it was a kind of homecoming for me, being able to work with two of the lecturers who&rsquo;d taught me Computer Science as an undergraduate (a gruelling task no doubt). On that note I&rsquo;ll point out that any errors or misunderstandings are mine alone since Paul and Isi are outstanding computer scientists.</p>
<p>We decided to model the effects of failing reciprocal consistency for a busy, long-lived, eventually-consistent distributed graph database. We chose a scale-free graph as the basis for our model, and informally thought of it a social network with a few nodes representing popular celebrities with very high degree, the next few layers with increasing freqency and decreasing degree representing various levels of sub-celebrity influence, scaling all the down to many nodes with very low degree representing most ordinary people.</p>
<p>Our model treats a graph database as a collection of replica sets or shards each holding some fraction of the overall graph. It has to be distributed, of course, so that we can elicit the mechanical failure modes of distrbuted-edge partitioned graph databases. In our model, usually two connected nodes will be held on a single shard, and by implication so to will the relationships joining them be stored on that shard. However according to 
<a href="https://dblp.org/pid/147/5256.html" target="_blank" rel="noopener">research on graph partitioning algorithms</a> by my colleague 
<a href="https://www.linkedin.com/in/hugo-firth-11265711/?originalSubdomain=uk" target="_blank" rel="noopener">Hugo Firth</a>, a good partitioning still results in around 30% of relationships connecting nodes that are hosted on different shards - these relationships are said to be <em>distributed</em>.</p>
<p>The model allows for write-after-stale-read from a replica as one source of corruption, and also allowed mutually out of order update processing for relationship records that span shards as the other primary source of corruption. Out of order updates have a chance of being overwritten correctly before they&rsquo;re ever seen, but they also have a chance of the stale side of the relationship being read and used to compute future incorrect updates from where it becomes impossible to repair the data in the general case.</p>
<p>In our model, relationship records which cross shards are physically implemented as a two reciprocal records on each shard (a common real-world implementation strategy). That is if shard A has a node representing Rosa with an outgoing <code>FOLLOWS</code> relationship to a node representing Karl on shard B, then the Karl node on shard B should have an incoming <code>FOLLOWS</code> from Rosa on shard A.</p>
<p>// TODO: picture needed</p>
<p>Equally any properties on that relationship must be identical whether the relationship is traversed head to tail or tail to head.</p>
<p>// TODO: picture needed</p>
<p>We term this reciprocal consistency and it is an invariant on the database so that data can be safely stored. Any deviation from a reciprocally consistent state is corruption, and that corruption has a chance to spread through the graph.</p>
<p>Using the model, we showed that for a billions-node scale-free graph and ~10,000 TPS and with some conservative estimates for the likelihood of transactions being applied mutually out of order, that the system would be garbage (defined as 10% corruption) in around 12-18 months.</p>
<p>Since the model was computationally expensive (many hours of compute time needed for each minor parameter change) we used it to calibrate a computationally cheap numerical approximation which you can parameterise to see how your eventually consistent graph database might behave in production.</p>
<h2 id="its-not-about-eventual-consistency-its-about-uncoordinated-updates">It&rsquo;s not about eventual consistency, it&rsquo;s about uncoordinated updates</h2>
<p>Our suspicion going into this work was that eventual consistency was the problematic factor. Clearly if you can read a stale value and write back to the database based on that stale value, you&rsquo;re going to get logical corruption. But that can be mitigated, albeit at a cost in competent eventually consistent systems.</p>
<p>So, our focus on eventual consistency wasn&rsquo;t wrong, but it wasn&rsquo;t quite right either. In fact we found that the consistency model for how a <em>replication within a shard</em> was less important than how updates are  <em>delivered across shards</em>.</p>
<p>With hindsight, eventually consistent databases were obvious because they have no coordination at all and so by implication no <em>consistent ordering</em> of arrival/processing by receiving shards. What&rsquo;s surprising though is if we make the model more generous, we still get corruption.</p>
<p>Let&rsquo;s assume that the replicas in a shard converge immediately and that faults can never occur. This is an impossible, magical algorithm for replication, and still the database would suffer corruption.</p>
<p>The problem is of reciprocal consistency being undermined by race conditions in the presence of concurrent contended transactions. While we have fewer opportunities to read stale data in a single shard (because we assumed instant convergence), it&rsquo;s still possible that transactions will be delivered mutually out of order to a pair of shards.</p>
<p>Let&rsquo;s play this out. Consider two transactions <code>T1</code> and <code>T2</code> which both update a common cross-shard relationship <code>R</code> in some mutally incompatible manner. Drawing on the TitanDB example, this could be where one transaction tries to delete <code>R</code> while the other tries to update it.</p>
<p>There are two ways these transactions can achieve a consistent outcome and two ways in which they won&rsquo;t, and since we don&rsquo;t have any coordination logic to impose an ordering (on the basis that it inhibits scalability) then we have to rely on natural arrival order.</p>
<table>
<thead>
<tr>
<th>Shard 1</th>
<th style="text-align:center">Shard 2</th>
<th style="text-align:right">Consistent</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>T1-&gt;T2</code></td>
<td style="text-align:center"><code>T1-&gt;T2</code></td>
<td style="text-align:right">Yes</td>
</tr>
<tr>
<td><code>T2-&gt;T1</code></td>
<td style="text-align:center"><code>T2-&gt;T1</code></td>
<td style="text-align:right">Yes</td>
</tr>
<tr>
<td><code>T2-&gt;T1</code></td>
<td style="text-align:center"><code>T1-&gt;T2</code></td>
<td style="text-align:right">Maybe</td>
</tr>
<tr>
<td><code>T1-&gt;T2</code></td>
<td style="text-align:center"><code>T2-&gt;T1</code></td>
<td style="text-align:right">Maybe</td>
</tr>
</tbody>
</table>
<p>Corruption <em>can</em> occur when <code>T1</code> and <code>T2</code> are processed in different orders on different shards for operations that don&rsquo;t commute. In such cases reciprocal consistency will have been violated.</p>
<p>For example, if <code>T1</code> adds property <code>since:2010</code> to the <code>FOLLOWS</code> relationship between Rosa and Karl while concurrently <code>T2</code> adds property <code>since:2015</code> to the <code>FOLLOWS</code> relationship between Rosa and Karl, then we have a problem. Ideally we&rsquo;d like the values to converge to one of these, but they never will because there is no protocol to enforce consistency across the shards.</p>
<table>
<thead>
<tr>
<th>Shard 1 (<code>T1-&gt;T2</code>)</th>
<th>Shard 2 (<code>T2-&gt;T1</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>(Rosa)-[:FOLLOWS {since:2010}]-&gt;(remote) </code></td>
<td><code>(remote)-[:FOLLOWS {since:2015}]-&gt;(Karl)</code></td>
</tr>
</tbody>
</table>
<p>This is a type of non-deterministic corruption where one shard holds the &ldquo;correct&rdquo; record as seen in a strictly serializable history and the other shard holds the &ldquo;incorrect&rdquo; record. In this case the two transactions with inconsistent arrival order do not commute: one adds a property value to a relationship and one deletes that relationship.</p>
<p>It&rsquo;s possible that a subsquent write might immediately correct this error with no side-effects, and it&rsquo;s possible that the shard with the &ldquo;correct&rdquo; record might be read. But it&rsquo;s also possible that the shard with the &ldquo;incorrect&rdquo; record will be read, and those incorrect values used to seed further writes, propagating the corruption around the graph. In general, there is no recovery from this corruption when it spreads. It&rsquo;s often a coin toss as to which record is the correct one in the instant after it is written</p>
<p>I&rsquo;ll reiterate that: <em>without any hardware or software failures, your data will be irreversibly garbage within its production lifetime.</em> That&rsquo;s a shocking result for a class of technology that has a degree of market buy-in.</p>
<p>Our work has now been 
<a href="https://eprint.ncl.ac.uk/author_pubs.aspx?author_id=62181" target="_blank" rel="noopener">multiply peer reviewed and published</a>, with the most recent analysis being in the Journal 
<a href="https://jimwebber.org/publication/2020-qmsm/" target="_blank" rel="noopener">Queueing Models and Service Management</a>.</p>
<h2 id="when-is-strongly-consistent-not-strongly-consistent-when-its-not-consistently-applied">When is strongly consistent not strongly consistent? When it&rsquo;s not consistently applied.</h2>
<p>Other entrants to the graph database market must have also seen the risks of eventual consistency for graphs have and opted to build their offerings atop strongly consistent models to avoid these pitfalls. The approach that I&rsquo;ve seen in two databases (one closed source, one open) is to build strong guarantees into the replica sets (shards) that store the data. This is a very good starting point and is used in their marketing materials to give a sense of safety. Words like &ldquo;ACID&rdquo; and &ldquo;strongly consistent&rdquo; are used frequently to convey the safety properties of the systems.</p>
<p>But all is not well here. In fact, despite having better guarantees for consistency within a single replica set than eventually consistent databases, the same global ordering problem haunts these newer databases.</p>
<p>// They fall foul of consistency within a shard and anything goes between shards.</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>The research work was made possible by a continuing joint effort between Newcastle University and Neo4j. Many thanks to my academic collaborators 
<a href="https://www.ncl.ac.uk/computing/people/profile/paulezhilchelvan.html" target="_blank" rel="noopener">Paul Ezhilchelvan</a>, 
<a href="https://www.ncl.ac.uk/computing/people/profile/isimitrani.html#background" target="_blank" rel="noopener">Isi Mitrani</a>, and 
<a href="https://www.ncl.ac.uk/bigdata/people/people/waudbyjack.html" target="_blank" rel="noopener">Jack Waudby</a> for entertaining my hunches and putting them on a solid academic foundation.</p>
<p>My colleage 
<a href="https://www.linkedin.com/in/hugo-firth-11265711/?originalSubdomain=uk" target="_blank" rel="noopener">Hugo Firth</a> (ex-Newcastle Ph.D., like me) provided a great deal of valuable feedback in writing up this piece as well as day to day sensible discussions on reliability in distributed systems.</p>
<h2 id="like-this-want-to-get-more-involved">Like this? Want to get more involved?</h2>
<p>I&rsquo;ll make a final pitch and remind you that Neo4j are hiring. So if you want to work with Hugo and me, then take a look at 
<a href="https://neo4j.com/careers/" target="_blank" rel="noopener">our open roles</a>.</p>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/graph-databases/">graph databases</a>
  
  <a class="badge badge-light" href="/tag/consistency/">consistency</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/2020-12-weak-stong-consistency/&amp;text=Strong%20Consitency%20Claims%20in%20Distributed%20Graph%20Databases" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/2020-12-weak-stong-consistency/&amp;t=Strong%20Consitency%20Claims%20in%20Distributed%20Graph%20Databases" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Strong%20Consitency%20Claims%20in%20Distributed%20Graph%20Databases&amp;body=/post/2020-12-weak-stong-consistency/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/2020-12-weak-stong-consistency/&amp;title=Strong%20Consitency%20Claims%20in%20Distributed%20Graph%20Databases" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=Strong%20Consitency%20Claims%20in%20Distributed%20Graph%20Databases%20/post/2020-12-weak-stong-consistency/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/2020-12-weak-stong-consistency/&amp;title=Strong%20Consitency%20Claims%20in%20Distributed%20Graph%20Databases" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  
  





  
    
    
    
      
    
    
    
    <div class="media author-card content-widget-hr">
      
        
        <img class="avatar mr-3 avatar-circle" src="/author/dr.-jim-webber/avatar_hua063f72fafcff2cee8f7b2c1e3059f36_530492_270x270_fill_lanczos_center_2.png" alt="Dr. Jim Webber">
      

      <div class="media-body">
        <h5 class="card-title"><a href="/">Dr. Jim Webber</a></h5>
        <h6 class="card-subtitle">Chief Scientist</h6>
        <p class="card-text">I&rsquo;m a computer scientist interested in fault-tolerance for graph databases.</p>
        <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:jim@jimwebber.org" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/jimwebber" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/jimwebber" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

      </div>
    </div>
  














  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/publication/2023-01-patent-11544280/">Bi-gram cardinality estimation in a graph database</a></li>
      
      <li><a href="/publication/2022-10-patent-11475065/">Pre-emptive graph search for guided natural language interactions with connected data systems</a></li>
      
    </ul>
  </div>
  





  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js" integrity="sha512-7t8APmYpzEsZP7CYoA7RfMPV9Bb+PJHa9x2WiUnDXZx3XHveuyWUtvNOexhkierl5flZ3tr92dP1mMS+SGlD+A==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.3b2b658c61ebd725bd5fc606c89fe44c.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    ©2023 Jim Webber
  </p>

  
  






  <p class="powered-by">
    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
